-- DROP AFTER DELETE TRIGGER
DROP TRIGGER IF EXISTS `tr_replacement_certificate_draft_ad`;

CREATE TRIGGER `tr_replacement_certificate_draft_ad`
AFTER DELETE ON `replacement_certificate_draft`
FOR EACH ROW INSERT INTO `replacement_certificate_draft_hist` (`hist_transaction_type`,
                                                               `hist_batch_number`,
                                                               `id`,
                                                               `mot_test_id`,
                                                               `mot_test_version`,
                                                               `odometer_reading_id`,
                                                               `vrm`,
                                                               `empty_vrm_reason_id`,
                                                               `vin`,
                                                               `empty_vin_reason_id`,
                                                               `vehicle_testing_station_id`,
                                                               `make_id`,
                                                               `make_name`,
                                                               `model_id`,
                                                               `model_name`,
                                                               `primary_colour_id`,
                                                               `secondary_colour_id`,
                                                               `country_of_registration_id`,
                                                               `expiry_date`,
                                                               `different_tester_reason_id`,
                                                               `replacement_reason`,
                                                               `is_vin_registration_changed`,
                                                               `mot1_legacy_id`,
                                                               `created_by`,
                                                               `created_on`,
                                                               `last_updated_by`,
                                                               `last_updated_on`,
                                                               `version`,
                                                               `batch_number`,
                                                               `is_deleted`)
VALUES ('D',
        COALESCE(@BATCH_NUMBER, 0),
        OLD.`id`,
        OLD.`mot_test_id`,
        OLD.`mot_test_version`,
        OLD.`odometer_reading_id`,
        OLD.`vrm`,
        OLD.`empty_vrm_reason_id`,
        OLD.`vin`,
        OLD.`empty_vin_reason_id`,
        OLD.`vehicle_testing_station_id`,
        OLD.`make_id`,
        OLD.`make_name`,
        OLD.`model_id`,
        OLD.`model_name`,
        OLD.`primary_colour_id`,
        OLD.`secondary_colour_id`,
        OLD.`country_of_registration_id`,
        OLD.`expiry_date`,
        OLD.`different_tester_reason_id`,
        OLD.`replacement_reason`,
        OLD.`is_vin_registration_changed`,
        OLD.`mot1_legacy_id`,
        OLD.`created_by`,
        OLD.`created_on`,
        OLD.`last_updated_by`,
        OLD.`last_updated_on`,
        OLD.`version`,
        OLD.`batch_number`,
        OLD.`is_deleted`);


-- DROP AFTER UPDATE TRIGGER
DROP TRIGGER IF EXISTS `tr_replacement_certificate_draft_au`;

CREATE TRIGGER `tr_replacement_certificate_draft_au`
AFTER UPDATE ON `replacement_certificate_draft`
FOR EACH ROW INSERT INTO `replacement_certificate_draft_hist` (`hist_transaction_type`,
                                                               `hist_batch_number`,
                                                               `id`,
                                                               `mot_test_id`,
                                                               `mot_test_version`,
                                                               `odometer_reading_id`,
                                                               `vrm`,
                                                               `empty_vrm_reason_id`,
                                                               `vin`,
                                                               `empty_vin_reason_id`,
                                                               `vehicle_testing_station_id`,
                                                               `make_id`,
                                                               `make_name`,
                                                               `model_id`,
                                                               `model_name`,
                                                               `primary_colour_id`,
                                                               `secondary_colour_id`,
                                                               `country_of_registration_id`,
                                                               `expiry_date`,
                                                               `different_tester_reason_id`,
                                                               `replacement_reason`,
                                                               `is_vin_registration_changed`,
                                                               `mot1_legacy_id`,
                                                               `created_by`,
                                                               `created_on`,
                                                               `last_updated_by`,
                                                               `last_updated_on`,
                                                               `version`,
                                                               `batch_number`,
                                                               `is_deleted`)
VALUES ('U',
        COALESCE(@batch_number, CASE WHEN NEW.BATCH_NUMBER <> OLD.BATCH_NUMBER THEN NEW.BATCH_NUMBER
                                ELSE 0 END),
        OLD.`id`,
        OLD.`mot_test_id`,
        OLD.`mot_test_version`,
        OLD.`odometer_reading_id`,
        OLD.`vrm`,
        OLD.`empty_vrm_reason_id`,
        OLD.`vin`,
        OLD.`empty_vin_reason_id`,
        OLD.`vehicle_testing_station_id`,
        OLD.`make_id`,
        OLD.`make_name`,
        OLD.`model_id`,
        OLD.`model_name`,
        OLD.`primary_colour_id`,
        OLD.`secondary_colour_id`,
        OLD.`country_of_registration_id`,
        OLD.`expiry_date`,
        OLD.`different_tester_reason_id`,
        OLD.`replacement_reason`,
        OLD.`is_vin_registration_changed`,
        OLD.`mot1_legacy_id`,
        OLD.`created_by`,
        OLD.`created_on`,
        OLD.`last_updated_by`,
        OLD.`last_updated_on`,
        OLD.`version`,
        OLD.`batch_number`,
        OLD.`is_deleted`);