-- ------------------------------------------------ --
-- SYSTEM SCRIPT: CREATE AUDIT TRIGGERS FOR A TABLE --
-- ------------------------------------------------ --

SET SESSION group_concat_max_len = 9999999999;                                   

SET @TARGET_SCHEMA='#SCHEMA#';
SET @SOURCE_SCHEMA='#SCHEMA#';
SET @TAB_NAME='#TABLENAME#';



SELECT CONCAT('
-- Create triggers for ',@SOURCE_SCHEMA,'.',TABLE_NAME,'
',drop_tr_ai,';

',create_tr_ai,'

') cmd
FROM (
SELECT TABLE_NAME, 
CONCAT('DROP TRIGGER IF EXISTS `', @TARGET_SCHEMA, '`.`tr_', TABLE_NAME, '_ai`') AS drop_tr_ai,
CONCAT('DELIMITER $$
CREATE TRIGGER `tr_',LEFT(TABLE_NAME,58),'_ai` AFTER INSERT 
ON `',@SOURCE_SCHEMA,'`.`',
TABLE_NAME, '` FOR EACH ROW 

BEGIN
INSERT INTO  `',@TARGET_SCHEMA,'`.`',LEFT(TABLE_NAME,59),'_hist` 
(`',GROUP_CONCAT(COLUMN_NAME SEPARATOR '`,
`'),'`, 
`last_updated_by`, 
`last_updated_on`) 
VALUES (NEW.`',GROUP_CONCAT(COLUMN_NAME SEPARATOR '`,
NEW.`'),'`, 
NEW.`created_by`, 
NEW.`created_on`);
END;
$$','
','DELIMITER ;') AS create_tr_ai
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = @SOURCE_SCHEMA
AND TABLE_NAME = @TAB_NAME AND COLUMN_NAME NOT IN ('last_updated_by', 'last_updated_on')
GROUP BY TABLE_NAME ) tmp_table;




SELECT CONCAT('
-- Create triggers for ',@SOURCE_SCHEMA,'.',TABLE_NAME,'
',drop_tr_au,';

',create_tr_au,'

',drop_tr_ad,';

',create_tr_ad,'

') cmd
FROM (
SELECT TABLE_NAME, 
CONCAT('DROP TRIGGER IF EXISTS `', @TARGET_SCHEMA, '`.`tr_', TABLE_NAME, '_au`') AS drop_tr_au,
CONCAT('DELIMITER $$
CREATE TRIGGER `tr_',LEFT(TABLE_NAME,58),'_au` AFTER UPDATE 
ON `',@SOURCE_SCHEMA,'`.`',
TABLE_NAME, '` FOR EACH ROW 

BEGIN
UPDATE ', @TARGET_SCHEMA, '.', @TAB_NAME, '_hist 
SET `expired_by` = NEW.`last_updated_by`,
`expired_on` = current_timestamp(6)
WHERE `id` = OLD.`id` and `expired_on` is null; 

INSERT INTO  `',@TARGET_SCHEMA,'`.`',LEFT(TABLE_NAME,59),'_hist` 
(`',GROUP_CONCAT(COLUMN_NAME SEPARATOR '`,
`'),'`) 
VALUES (NEW.`',GROUP_CONCAT(COLUMN_NAME SEPARATOR '`,
NEW.`'),'`);
END;
$$','
','DELIMITER ;') AS create_tr_au,

CONCAT('DROP TRIGGER IF EXISTS `', @TARGET_SCHEMA, '`.`tr_', TABLE_NAME, '_ad`') AS drop_tr_ad,
CONCAT('DELIMITER $$
CREATE TRIGGER `tr_',LEFT(TABLE_NAME,58),'_ad` AFTER DELETE 
ON `',@SOURCE_SCHEMA,'`.`',
TABLE_NAME, '` FOR EACH ROW 

BEGIN
  UPDATE ', @TARGET_SCHEMA, '.', @TAB_NAME, '_hist 
  SET `expired_on` = current_timestamp(6)
  WHERE `id` = OLD.`id` and `expired_on` is null;
END;
$$','
','DELIMITER ;') AS create_tr_ad 
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = @SOURCE_SCHEMA
AND TABLE_NAME = @TAB_NAME
GROUP BY TABLE_NAME ) tmp_table;


